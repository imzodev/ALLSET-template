<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Theme Color Manager</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
      background-color: #f9fafb;
    }
    .color-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
      gap: 16px;
    }
    .color-option {
      aspect-ratio: 1/1;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s ease;
      position: relative;
      overflow: hidden;
      box-shadow: 0 1px 3px rgba(0,0,0,0.12), 0 1px 2px rgba(0,0,0,0.24);
    }
    .color-option:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    .color-option.selected {
      box-shadow: 0 0 0 3px white, 0 0 0 6px currentColor;
    }
    .color-option .label {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      background-color: rgba(0,0,0,0.6);
      color: white;
      padding: 4px;
      font-size: 12px;
      text-align: center;
      opacity: 0;
      transition: opacity 0.2s ease;
    }
    .color-option:hover .label {
      opacity: 1;
    }
    .color-preview {
      width: 100%;
      height: 100px;
      border-radius: 8px;
      margin-bottom: 16px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.12), 0 1px 2px rgba(0,0,0,0.24);
      transition: all 0.3s ease;
    }
    .custom-color-input {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .custom-color-input input[type="color"] {
      width: 50px;
      height: 50px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      padding: 0;
      background: none;
    }
    .custom-color-input input[type="color"]::-webkit-color-swatch-wrapper {
      padding: 0;
    }
    .custom-color-input input[type="color"]::-webkit-color-swatch {
      border: none;
      border-radius: 8px;
    }
    .message {
      transition: all 0.3s ease;
      max-height: 0;
      overflow: hidden;
      opacity: 0;
    }
    .message.show {
      max-height: 100px;
      opacity: 1;
      margin-top: 16px;
    }
    .back-button {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      margin-bottom: 16px;
      color: #4b5563;
      text-decoration: none;
      font-size: 14px;
    }
    .back-button:hover {
      color: #1f2937;
    }
    .loading {
      position: relative;
    }
    .loading::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(255,255,255,0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 8px;
    }
    .loading::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 24px;
      height: 24px;
      border: 3px solid rgba(0,0,0,0.1);
      border-top-color: #3b82f6;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      z-index: 10;
    }
    @keyframes spin {
      to { transform: translate(-50%, -50%) rotate(360deg); }
    }
  </style>
</head>
<body class="p-4 md:p-8">
  <div class="max-w-3xl mx-auto bg-white p-6 rounded-lg shadow-md">
    <a href="/allset/settings" class="back-button">
      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M19 12H5M12 19l-7-7 7-7"/>
      </svg>
      Back to Settings
    </a>

    <h1 class="text-2xl font-bold mb-6">Theme Color Manager</h1>

    <div class="mb-6">
      <h2 class="text-lg font-semibold mb-2">Current Theme Color</h2>
      <div class="color-preview" id="color-preview"></div>
      <div class="flex items-center justify-between">
        <p class="text-gray-700">Hex: <span id="color-hex" class="font-mono"></span></p>
        <button id="apply-button" class="px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600 transition-colors">
          Apply Changes
        </button>
      </div>
    </div>

    <div class="mb-6">
      <h2 class="text-lg font-semibold mb-4">Preset Colors</h2>
      <div class="color-grid">
        <div class="color-option" style="background-color: #3b82f6;" data-color="#3b82f6" data-name="Blue">
          <div class="label">Blue</div>
        </div>
        <div class="color-option" style="background-color: #ef4444;" data-color="#ef4444" data-name="Red">
          <div class="label">Red</div>
        </div>
        <div class="color-option" style="background-color: #10b981;" data-color="#10b981" data-name="Green">
          <div class="label">Green</div>
        </div>
        <div class="color-option" style="background-color: #f59e0b;" data-color="#f59e0b" data-name="Amber">
          <div class="label">Amber</div>
        </div>
        <div class="color-option" style="background-color: #8b5cf6;" data-color="#8b5cf6" data-name="Purple">
          <div class="label">Purple</div>
        </div>
        <div class="color-option" style="background-color: #ec4899;" data-color="#ec4899" data-name="Pink">
          <div class="label">Pink</div>
        </div>
        <div class="color-option" style="background-color: #06b6d4;" data-color="#06b6d4" data-name="Cyan">
          <div class="label">Cyan</div>
        </div>
        <div class="color-option" style="background-color: #14b8a6;" data-color="#14b8a6" data-name="Teal">
          <div class="label">Teal</div>
        </div>
        <div class="color-option" style="background-color: #f97316;" data-color="#f97316" data-name="Orange">
          <div class="label">Orange</div>
        </div>
        <div class="color-option" style="background-color: #6366f1;" data-color="#6366f1" data-name="Indigo">
          <div class="label">Indigo</div>
        </div>
      </div>
    </div>

    <div class="mb-6">
      <h2 class="text-lg font-semibold mb-4">Custom Color</h2>
      <div class="custom-color-input">
        <input type="color" id="custom-color-picker" value="#3b82f6">
        <input type="text" id="custom-color-text" value="#3b82f6" class="border border-gray-300 rounded-md px-3 py-2 flex-grow">
        <button id="custom-color-button" class="px-4 py-2 bg-gray-800 text-white rounded-md hover:bg-gray-900 transition-colors">
          Preview
        </button>
      </div>
    </div>

    <div id="message" class="message p-4 rounded-md"></div>
  </div>

  <script>
    // Elements
    const colorPreview = document.getElementById('color-preview');
    const colorHex = document.getElementById('color-hex');
    const colorOptions = document.querySelectorAll('.color-option');
    const customColorPicker = document.getElementById('custom-color-picker');
    const customColorText = document.getElementById('custom-color-text');
    const customColorButton = document.getElementById('custom-color-button');
    const applyButton = document.getElementById('apply-button');
    const messageEl = document.getElementById('message');

    // State
    let currentColor = '#3b82f6';
    let selectedColor = '#3b82f6';
    let isLoading = false;

    // Function to update the color preview
    function updateColorPreview(color) {
      colorPreview.style.backgroundColor = color;
      colorHex.textContent = color;
      selectedColor = color;

      // Update selected state of color options
      colorOptions.forEach(option => {
        if (option.dataset.color.toLowerCase() === color.toLowerCase()) {
          option.classList.add('selected');
          option.style.boxShadow = `0 0 0 3px white, 0 0 0 6px ${color}`;
        } else {
          option.classList.remove('selected');
          option.style.boxShadow = '';
        }
      });

      // Update custom color inputs
      customColorPicker.value = color;
      customColorText.value = color;
    }

    // Function to show a message
    function showMessage(text, isSuccess = true) {
      messageEl.textContent = text;
      messageEl.className = `message p-4 rounded-md show ${isSuccess ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}`;

      // Hide the message after 3 seconds
      setTimeout(() => {
        messageEl.className = 'message p-4 rounded-md';
      }, 3000);
    }

    // Function to set loading state
    function setLoading(loading) {
      isLoading = loading;
      if (loading) {
        colorPreview.classList.add('loading');
        applyButton.disabled = true;
        applyButton.classList.add('opacity-50', 'cursor-not-allowed');
      } else {
        colorPreview.classList.remove('loading');
        applyButton.disabled = false;
        applyButton.classList.remove('opacity-50', 'cursor-not-allowed');
      }
    }

    // Function to set the theme color
    async function setThemeColor(color) {
      if (isLoading) return;

      setLoading(true);
      try {
        const response = await fetch('/api/theme', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ primaryColor: color }),
        });

        if (response.ok) {
          currentColor = color;
          showMessage(`Theme color set to ${color}. The changes are now permanent for all users.`);
        } else {
          showMessage('Failed to set theme color', false);
        }
      } catch (error) {
        console.error('Error setting theme color:', error);
        showMessage('Error setting theme color', false);
      } finally {
        setLoading(false);
      }
    }

    // Add click event listeners to the color options
    colorOptions.forEach(option => {
      option.addEventListener('click', () => {
        const color = option.dataset.color;
        updateColorPreview(color);
      });
    });

    // Sync custom color picker and text input
    customColorPicker.addEventListener('input', () => {
      customColorText.value = customColorPicker.value;
    });

    customColorText.addEventListener('input', () => {
      // Validate hex color format
      const hexRegex = /^#([A-Fa-f0-9]{6}|[A-Fa-f0-9]{3})$/;
      if (hexRegex.test(customColorText.value)) {
        customColorPicker.value = customColorText.value;
      }
    });

    // Preview custom color
    customColorButton.addEventListener('click', () => {
      const hexRegex = /^#([A-Fa-f0-9]{6}|[A-Fa-f0-9]{3})$/;
      if (hexRegex.test(customColorText.value)) {
        updateColorPreview(customColorText.value);
      } else {
        showMessage('Please enter a valid hex color (e.g., #3b82f6)', false);
      }
    });

    // Apply button click handler
    applyButton.addEventListener('click', () => {
      if (selectedColor !== currentColor) {
        setThemeColor(selectedColor);
      } else {
        showMessage('This color is already applied');
      }
    });

    // Load the current theme color on page load
    async function loadCurrentTheme() {
      setLoading(true);
      try {
        const response = await fetch('/api/theme');
        if (response.ok) {
          const data = await response.json();
          currentColor = data.primaryColor;
          updateColorPreview(data.primaryColor);
        }
      } catch (error) {
        console.error('Error loading theme:', error);
        showMessage('Error loading current theme', false);
      } finally {
        setLoading(false);
      }
    }

    // Load the current theme on page load
    loadCurrentTheme();
  </script>
</body>
</html>
